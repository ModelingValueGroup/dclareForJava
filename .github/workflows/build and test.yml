name: build and test

on: [push]

jobs:
  build-and-test:

    runs-on: ubuntu-latest

    steps:
      - name: "checkout"
        uses: actions/checkout@v1

      - name: "attach head"
        run: git checkout "${GITHUB_REF#refs/heads/}"

      - name: "setup JDK"
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: "get generic info"
        uses: ModelingValueGroup/generic-info@master

      - name: "get buildTools"
        uses: ModelingValueGroup/buildTools@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "prepare ant"
        run:  |
          cat <<EOF >build.properties
          jdk.home.11=$JAVA_HOME
          path.variable.maven_repository=$HOME/.m2/repository
          EOF

      - name: "(re)generate some files"
        run:  |
          . <(java -jar buildTools.jar)
          updateAllPomsFromIntellijDependencies
          generateAntTestFilesFromIntellij
          generateAntJavadocFilesFromIntellij
          cleanupIntellijAntFiles
          correctEols
          correctHeaders header

      - name: "download dependencies (as mentioned in pom)"
        run:  |
          . <(java -jar buildTools.jar)
          sed 's/^/@@@ /' pom.xml
          mkdir -p lib
          mvn_ ${{ secrets.GITHUB_TOKEN }} dependency:copy-dependencies -DoutputDirectory=lib

      - name: "build"
        run:  ant

      - name: "test"
        run:  ant test.results.jar.dclareForJava

      - name: "javadoc"
        run:  ant javadoc.module.dclareForJava

      - name: "DEBUG"
        run:  find . -type f

      - name: "upload dclareForJava.jar"
        uses: actions/upload-artifact@v1
        with:
          name: jdclare.jar
          path: out/artifacts/dclareForJava.jar

      - name: "upload dclareForJava-sources.jar"
        uses: actions/upload-artifact@v1
        with:
          name: dclareForJava-sources.jar
          path: out/artifacts/dclareForJava-sources.jar

      - name: "upload dclareForJava-javadoc.jar"
        uses: actions/upload-artifact@v1
        with:
          name: dclareForJava-javadoc.jar
          path: out/artifacts/dclareForJava-javadoc.jar

      - name: "upload dclareForJava-testresults.jar"
        uses: actions/upload-artifact@v1
        with:
          name: dclareForJava-testresults.jar
          path: out/artifacts/dclareForJava-testresults.jar

      - name: "push changes back to github"
        run:  |
          . <(java -jar buildTools.jar)
          pushBackToGithub "${{ secrets.GITHUB_TOKEN }}" "automation@modelingvalue.com" "adjusted files [by github actions]"

      - name: "upload package dclareForJava.jar"
        uses: ModelingValueGroup/upload-maven-package-action@master
        if: github.ref == 'refs/heads/master'
        with:
          file: "out/artifacts/dclareForJava.jar"
          token: "${{ secrets.GITHUB_TOKEN }}"
